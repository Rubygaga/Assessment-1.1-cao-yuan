---
title: "Assessment 3 Business report"
author: "CAO YUAN 4659774 , Lim Chiu Yee 4663994"
date: "9/8/2021"
output: html_document
---

```{r}
library(tidyverse)
library(dplyr)
library(skimr)
library(knitr)
library(reader)
library(readxl)
library(tidymodels)
```
### Introduction
#### Public concern about climate change has increased greatly in recent years. Humans are beginning to realize that their actions are releasing large amounts of carbon into the atmosphere in the form of carbon dioxide (CO2). As highlighted by the growing vegan movement, humans are beginning to understand the carbon footprint left by our eating habits.

### Data And Sources
```{r}
Food_consumption <- read_excel("Food consumption.xlsx")
```

```{r}
Food_consumption %>%
  head(10) %>%
  kable()
```
### Data Summary

#### Using a preliminary skim, the dataset has 130 unique countries, each tagged with 11 different categories of food, and no missing values.
```{r}
skim(Food_consumption)
```
#### This data was found in the TidyTuesday data repository of GitHub. The data, supplied from German Company Nu3 and the Food and Agriculture Organization of the United Nations (FAO), was collected in 2017 and measures the quantity of food supplied for consumption of 11 food types for all countries researched, and its respective carbon footprint on a per-capita basis. The data contains 1430 observations of 4 variables: Country, Food Category, Consumption (per-capita in KG), and CO2 Emission (per-capita in KG). As we can see, data looks clean and properly arranged. There are 4 columns. We have the country, the category of the food consumed, how much is consumed, and how much CO2 is emitted. Some important units provided in the README:

#### - Consumption is measured in kg/person/year
#### - Co2 Emission is measured in kg CO2/person/year


## Data Exploration

### Major Question:
#### Can we predict the Co2 emission depends on the food consumption and food categories?
### Subquestions:
#### Q1:How about relation between consumption and emission in every food category?

#### First of all, we will try to see how food consumption and co2 emission are distributed using a point plot.
```{r}
Food_consumption %>% 
  ggplot(aes(consumption, co2_emmission)) +
    geom_point(color = "orange", alpha = 0.3, position = "jitter") +
    stat_smooth(method="lm", se=FALSE,size = 0.3) +
    labs(title = "CO2 emission vs Food Consumption",
         x = "Food Consumption (kg/person/year)",
         y = "CO2 Emission (kg/person/year)"
         )

```
#### The above graph shows a strong positive linear relationship between food consumption and CO2 emissions, and it seems to vary depending on the type of food consumed. Next we can explore what kind of distribution would be presented by splitting according to food type.It strongly suggests that there is a mathematical relationship to calculate the carbon emission level when food consumption is known.

```{r}
Food_consumption %>%
 gather(key = "feature", value = "value", -food_category, -country) %>%
 mutate(feature = str_to_title(feature %>% str_replace("_", " "))) %>% 
 ggplot() +
 geom_bar(aes(x = feature, y = value, fill = feature), stat = "identity") +
 facet_wrap(~food_category, scales = "free") +
 theme(legend.position = "bottom",
       axis.text.x = element_blank()) + 
 labs(x = "Features",
      y = element_blank(),
      fill = "Feature")
```

#### Based on the existing dataset we create another column to help us classify the dataset into animal and non-animal food.
```{r}
Food_consumption_1 <- Food_consumption %>% 
    mutate(Animal_Category = if_else(food_category %in% c("Beef", "Pork", "Poultry", "Lamb & Goat", "Fish", "Eggs", "Milk - inc. cheese"), "Animal", "Non Animal"))

Food_consumption %>% head() %>% knitr::kable()
```

```{r}
Food_consumption_1 %>% 
  ggplot(aes(consumption, co2_emmission, colour = Animal_Category)) +
     stat_smooth(method="lm", se=FALSE,size = 1)
   
```
#### The most important takeaway from this study is that there are huge differences in CO2 emissions for different foods.Clearly, animal-based foods tend to have a higher footprint than nonanimal-based food.

#### Mean CO2 emission across various food categories

#####To delve into it further, I decided to group the data points by food type, and find the average CO2 emission of each respective group.

```{r}
Food_consumption %>% 
  group_by(food_category) %>% 
  summarize(avg.co2 = sum(co2_emmission)/n()) %>% 
  ggplot(aes(fct_reorder(food_category, avg.co2), avg.co2, fill = food_category)) +
  geom_col(show.legend = F,position='identity',alpha=0.5) +
   theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1))+
  labs( title = "Mean CO2 emission across various food categories",
    x = "Food Categories",
    y = "Average CO2 Emissions"
  )
```
#### In the visualization, we see the average CO2 emissions from 11 different food categories, the least soybeans to the most beef.


```{r}
Food_consumption %>% 
  filter(food_category == "Beef") %>%
  arrange(desc(consumption)) %>% 
  top_n(20) %>% 
  ggplot(aes(fct_reorder(country, consumption), consumption, fill = country)) +
  geom_col(show.legend = F, alpha=0.7) +
  coord_flip() +
  labs(
    x = "Country",
    y = "Beef Consumption"
  )
```
#### Argentina topped the list by a wide margin. And a significant number of North and South American countries show up as big beef consumers.
#### Based on this data I tried to see if I could use CO2 emissions to predict whether a country belongs to the Americas or not.I used the countrycode package to create a new column to determine which continent a country belongs to, and further create a binary classification of whether the country belongs to the Americas.

```{r}
library(countrycode)
library(janitor)

food <- Food_consumption %>%
  select(-consumption) %>%
  pivot_wider(names_from = food_category,
              values_from = co2_emmission) %>%
  clean_names() %>%
  mutate(continent = countrycode(country,
                                 origin = "country.name",
                                 destination = "continent")) %>%
  mutate(americas = case_when(continent == "Americas" ~ "Americas",
                              TRUE ~ "Other")) %>%
  select(-country,-continent) %>%
  mutate_if(is.character, as_factor)

food %>% 
  select(americas, everything())
```

## Letâ€™s dive into modelling

### Data Splitting
#### We first split the dataset into a training set and a test set. I chose to use stratified random sampling, which is done by randomly selecting samples in each class.

```{r}
food_split <- initial_split(food)
food_train <- training(food_split)
food_test <- testing(food_split)
```

### Data Preprocessing
#### Next, we use the recipes package. The intuition behind this package is to define a recipe or blueprint that can be used to sequentially define the encodings and preprocessing of the data.

```{r}
food_rec <- recipe(americas ~ ., data = food_train) %>%
  step_corr(all_numeric()) %>%
  prep()
```

### Model Specification

```{r}
library(ranger)
rf_spec <- rand_forest(mode = "classification") %>%
  set_engine("ranger")
```

```{r}
rf_fit <- rf_spec %>% 
  fit(americas ~ .,
      data = juice(food_rec))
rf_fit 
```

### Model Evaluation
#### Now to compare training results versus test results.

```{r}
results_train <- rf_fit %>%
      predict(new_data = food_train) %>%
      mutate(truth = food_train$americas) %>%
      conf_mat(truth, .pred_class) %>%
      summary() %>%
      mutate(model = "rf")


results_test <-rf_fit %>%
      predict(new_data = bake(food_rec, food_test)) %>%
      mutate(truth = food_test$americas) %>%
      conf_mat(truth, .pred_class) %>%
      summary() %>%
      mutate(model = "rf")

```

```{r}
library(patchwork) #to combine ggplots

p1 <- results_train %>%
  filter(.metric %in% c("accuracy", "precision", "recall", "f_meas")) %>%
  ggplot(aes(.metric, .estimate)) +
  geom_col() +
  geom_text(aes(label = round(.estimate, 2)),
            position = position_dodge(width = 0.9), vjust = -0.5) + 
  labs(
    x = "Performance Metrics (Training Data)",
    y = "Score"
  )

p2 <- results_test %>%
  filter(.metric %in% c("accuracy", "precision", "recall", "f_meas")) %>%
  ggplot(aes(.metric, .estimate)) +
  geom_col() +
  geom_text(aes(label = round(.estimate, 2)),
            position = position_dodge(width = 0.9), vjust = -0.5) + 
  labs(
    x = "Performance Metrics (Test Data)",
    y = "Score"
  )

p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = 'bottom')
```

